<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Deployment | Crossfeed</title>



<meta name="description" content="Crossfeed">





    



<link rel="stylesheet"
  href="/assets/css/uswds-theme.css"
  media="screen">


    
  </head>
  <body class="  ">

    <a class="usa-skipnav" href="#main-content">Skip to main content</a>

    


  <section class="usa-banner" aria-label="Official government website">
  <div class="usa-accordion">
    <header class="usa-banner__header">
      <div class="usa-banner__inner">
        <div class="grid-col-auto">
          <img class="usa-banner__header-flag" src="/assets/uswds/img/us_flag_small.png" alt="U.S. flag">
        </div>
        <div class="grid-col-fill tablet:grid-col-auto">
          <p class="usa-banner__header-text">An official website of the United States government</p>
          <p class="usa-banner__header-action" aria-hidden="true">Here’s how you know</p>
        </div>
        <button class="usa-accordion__button usa-banner__button"
          aria-expanded="false" aria-controls="gov-banner">
          <span class="usa-banner__button-text">Here’s how you know</span>
        </button>
      </div>
    </header>
    <div class="usa-banner__content usa-accordion__content" id="gov-banner">
      <div class="grid-row grid-gap-lg">
        <div class="usa-banner__guidance tablet:grid-col-6">
          <img class="usa-banner__icon usa-media-block__img" src="/assets/uswds/img/icon-dot-gov.svg" alt="Dot gov">
          <div class="usa-media-block__body">
            <p>
              <strong>The .gov means it’s official.</strong>
              <br>
              Federal government websites often end in .gov or .mil. Before sharing sensitive information, make sure you’re on a federal government site.
            </p>
          </div>
        </div>
        <div class="usa-banner__guidance tablet:grid-col-6">
          <img class="usa-banner__icon usa-media-block__img" src="/assets/uswds/img/icon-https.svg" alt="Https">
          <div class="usa-media-block__body">
            <p>
              <strong>The site is secure.</strong>
              <br>
              The <strong>https://</strong> ensures that you are connecting to the official website and that any information you provide is encrypted and transmitted securely.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>




  <div class="usa-overlay"></div>

  <header class="usa-header usa-header--basic" role="banner">


  
    <div class="usa-nav-container">
  
    <div class="usa-navbar">
      <div class="usa-logo" id="header-logo">
        <a
          href="/"
          title="Home">
          
          <em class="usa-logo__text">
            Crossfeed
          </em>
        </a>
      </div>
      <button class="usa-menu-btn">Menu</button>
    </div>

    <nav role="navigation" class="usa-nav">
      <div class="usa-nav__inner">
        <button class="usa-nav__close">
          <img src="/assets/uswds/img/close.svg" alt="close">
        </button>

        
        
        
        <ul class="usa-nav__primary usa-accordion">
          
          <li class="usa-nav__primary-item">
            
              <a class=" usa-nav__link  " href="/usage/">
                <span>User Guide</span>
              </a>
            
          </li>
          
          <li class="usa-nav__primary-item">
            
              <a class=" usa-nav__link  " href="/contributing/">
                <span>Contributing</span>
              </a>
            
          </li>
          
          <li class="usa-nav__primary-item">
            
              <a class=" usa-nav__link  " href="/scans/">
                <span>Scanning FAQ</span>
              </a>
            
          </li>
          
        </ul>
        

        
          
          
        

        


        </div>
      </div>
    </nav>
  
    </div>
  
  </header>




    
    


    

    

    
      
      




    
    

    
      <div class="usa-section">
  <div class="grid-container">
    <div class="grid-row grid-gap flex-align-start">
      
      
        <div class="usa-layout-docs__sidenav desktop:grid-col-3">
          <nav aria-label="Secondary navigation">
  <ul class="usa-sidenav">
    
      
      
      
    <li class="usa-sidenav__item">
      <a href="/contributing/"
         
          >
         Contribution Guidelines
      </a>
      
    </li>
    
      
      
      
    <li class="usa-sidenav__item">
      <a href="/contributing/setup/"
         
          >
         Development Setup
      </a>
      
    </li>
    
      
      
      
    <li class="usa-sidenav__item">
      <a href="/contributing/architecture/"
         
          >
         Architecture
      </a>
      
    </li>
    
      
      
      
    <li class="usa-sidenav__item">
      <a href="/contributing/deployment/"
          class="usa-current" 
          >
         Deployment
      </a>
      
      <ul class="usa-sidenav__sublist">
        
  <li>
    <a href="#manual-deployment" >Manual Deployment </a>
  </li>

  <li>
    <a href="#first-time-setup" >First-time Setup </a>
  </li>


      </ul>
      
    </li>
    
  </ul>
</nav>

        </div>
      

      <main class="usa-layout-docs usa-layout-docs__main usa-prose desktop:grid-col-9" id="main-content">
        
          <h1>Deployment</h1>
        
        <h2 id="manual-deployment">Manual Deployment</h2>

<p>Deployment is done automatically through GitHub Actions. Any code pushed to the <code class="language-plaintext highlighter-rouge">master</code> branch is automatically deployed to the Crossfeed staging site, and any code pushed to the <code class="language-plaintext highlighter-rouge">production</code> branch is automatically deployed to the production site.</p>

<p>The following sections detail the manual deployment process for staging.</p>

<h3 id="infrastructure">Infrastructure</h3>

<p>Infrastructure is managed by Terraform. To deploy to staging, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>infrastructure
make init
make plan
make apply
</code></pre></div></div>

<h3 id="backend">Backend</h3>

<p>The backend API is managed by the Serverless Framework. To deploy, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>backend
npx sls create_domain <span class="nt">--stage</span><span class="o">=</span>staging
npx sls deploy <span class="nt">--stage</span><span class="o">=</span>staging
</code></pre></div></div>

<p>To change the environment variables used to build the backend, edit <code class="language-plaintext highlighter-rouge">env.yaml</code>. Most of these
variables are set through SSM variables (which should be set manually / through Terraform – see below),
but some of these variables are hard-coded and configurable by just editing <code class="language-plaintext highlighter-rouge">env.yaml</code>.</p>

<h3 id="worker">Worker</h3>

<p>Deploying the worker involves building the Docker image and pushing it to ECR:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>backend
npm run deploy-worker
</code></pre></div></div>

<h3 id="frontend">Frontend</h3>

<p>Deploying the frontend involves building the React code, uploading it to an S3 bucket, then invalidating the Cloudfront cache:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>frontend
<span class="nb">cp </span>stage.env .env
npm run build
aws s3 <span class="nb">sync </span>build/ s3://staging.crossfeed.cyber.dhs.gov/ <span class="nt">--delete</span>
aws cloudfront create-invalidation <span class="nt">--distribution-id</span> ELM2YU1N4NV9M <span class="nt">--paths</span> <span class="s2">"/index.html"</span>
</code></pre></div></div>

<p>You may need to change the values in <code class="language-plaintext highlighter-rouge">stage.env</code> or <code class="language-plaintext highlighter-rouge">prod.env</code> if you need to change the environment variables
that are used to build the frontend.</p>

<h2 id="first-time-setup">First-time Setup</h2>

<p>To deploy this app for the first time, you need to do a couple of things:</p>

<ul>
  <li>Set up a custom domain for the frontend and create an ACM certificate for it</li>
  <li>Generate a login.gov RSA key</li>
  <li>Set initial SSM variables</li>
</ul>

<h3 id="generate-logingov-rsa-key">Generate login.gov RSA key</h3>

<p>Run the following to generate a login.gov RSA key (preferably in a non-git directory outside of crossfeed!):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa <span class="nt">-out</span> private.pem 2048
openssl req <span class="nt">-newkey</span> rsa:2048 <span class="nt">-nodes</span> <span class="nt">-days</span> 3650 <span class="nt">-out</span> csr.pem
openssl x509 <span class="nt">-req</span> <span class="nt">-in</span> csr.pem <span class="nt">-out</span> cert.pem <span class="nt">-signkey</span> private.pem
npm <span class="nb">install</span> <span class="nt">-g</span> pem-jwk
pem-jwk private.pem <span class="o">&gt;</span> private.jwk
</code></pre></div></div>

<p>Visit <a href="https://dashboard.int.identitysandbox.gov/">the Login.gov sandbox dashboard</a> to create a login.gov application, providing <code class="language-plaintext highlighter-rouge">cert.pem</code> as the public certificate. Copy the contents of <code class="language-plaintext highlighter-rouge">private.jwk</code> to use as your <code class="language-plaintext highlighter-rouge">LOGIN_GOV_JWT_KEY</code> in the next step.</p>

<h3 id="set-initial-ssm-variables">Set initial SSM variables</h3>

<p>First, make sure you set the following SSM variables manually through the AWS Console (replace <code class="language-plaintext highlighter-rouge">staging</code> with <code class="language-plaintext highlighter-rouge">prod</code> as needed). Make sure these variables are set as “SecureString”:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/DATABASE_USER</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/DATABASE_PASSWORD</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/APP_JWT_SECRET</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/CENSYS_API_ID</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/CENSYS_API_SECRET</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/LOGIN_GOV_REDIRECT_URI</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/LOGIN_GOV_BASE_URL</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/LOGIN_GOV_JWT_KEY</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/LOGIN_GOV_ISSUER</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/WORKER_USER_AGENT</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/WORKER_SIGNATURE_PUBLIC_KEY</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/WORKER_SIGNATURE_PRIVATE_KEY</code></li>
  <li><code class="language-plaintext highlighter-rouge">/crossfeed/staging/REACT_APP_TERMS_VERSION</code></li>
</ul>

<h3 id="create-service-linked-role-for-amazon-es">Create service-linked role for Amazon ES</h3>

<p>You must also <a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/slr-es.html#create-slr">create a service-linked role for Amazon ES</a> (this only needs to be created once per AWS account):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws iam create-service-linked-role <span class="nt">--aws-service-name</span> es.amazonaws.com
</code></pre></div></div>

<h3 id="use-terraform">Use Terraform</h3>

<p>Then, run <code class="language-plaintext highlighter-rouge">cp stage.config .env</code> and change the variables in <code class="language-plaintext highlighter-rouge">.env</code> to use a bucket you have access to to store state.</p>

<p>Make sure you configure the default AWS profile using <code class="language-plaintext highlighter-rouge">aws configure</code> , or set the <code class="language-plaintext highlighter-rouge">AWS_PROFILE</code> environment variable in <code class="language-plaintext highlighter-rouge">.env</code>.</p>

<p>Then run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i <span class="nt">-g</span> dotenv-cli
make init
make plan
make apply
</code></pre></div></div>


      </main>
    </div>
  </div>
</div>

    

    

    


  
<footer class="usa-footer">

  

  
    <div class="grid-container usa-footer__return-to-top">
      <a href="#">Return to top</a>
    </div>
  

  

  

</footer>





    





  
    
      <script src="/assets/uswds/js/uswds.min.js" async></script>
    

  
    






  </body>
</html>
